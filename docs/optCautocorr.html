<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Tutorial 3: correlated residuals | Bayesian Measurement and Verification</title>
<meta name="author" content="Simon Rouchier">
<meta name="description" content="In tutorial 2, we fitted a change-point model, function of outdoor air temperature, on the daily energy use data of a commercial building. It gave us an estimate of energy savings following an...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="Chapter 5 Tutorial 3: correlated residuals | Bayesian Measurement and Verification">
<meta property="og:type" content="book">
<meta property="og:description" content="In tutorial 2, we fitted a change-point model, function of outdoor air temperature, on the daily energy use data of a commercial building. It gave us an estimate of energy savings following an...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Tutorial 3: correlated residuals | Bayesian Measurement and Verification">
<meta name="twitter:description" content="In tutorial 2, we fitted a change-point model, function of outdoor air temperature, on the daily energy use data of a commercial building. It gave us an estimate of energy savings following an...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Bayesian Measurement and Verification</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li class="book-part">Background</li>
<li><a class="" href="back-mv.html"><span class="header-section-number">1</span> Measurement and verification</a></li>
<li><a class="" href="back-bayes.html"><span class="header-section-number">2</span> Bayesian data analysis</a></li>
<li class="book-part">Whole building M&amp;V: option C</li>
<li><a class="" href="optClinreg.html"><span class="header-section-number">3</span> Tutorial 1: linear regression and introduction to Stan</a></li>
<li><a class="" href="optCchangepoint.html"><span class="header-section-number">4</span> Tutorial 2: increasing model complexity</a></li>
<li><a class="active" href="optCautocorr.html"><span class="header-section-number">5</span> Tutorial 3: correlated residuals</a></li>
<li class="book-part">Option D</li>
<li><a class="" href="optDbasics.html"><span class="header-section-number">6</span> Option D basics</a></li>
<li><a class="" href="bayesian-calibration.html"><span class="header-section-number">7</span> Bayesian calibration</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/srouchier/bayesmv">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="optCautocorr" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Tutorial 3: correlated residuals<a class="anchor" aria-label="anchor" href="#optCautocorr"><i class="fas fa-link"></i></a>
</h1>
<p>In <a href="optCchangepoint.html#optCchangepoint">tutorial 2</a>, we fitted a change-point model, function of outdoor air temperature, on the daily energy use data of a commercial building. It gave us an estimate of energy savings following an energy conservation measure, with uncertainty. However we saw that the autocorrelation of the model’s prediction residuals was too high to trust this inference.</p>
<p>If a fitted model has autocorrelated residuals, then we have two options :</p>
<ul>
<li>If possible, improve the model itself with a better description of the building and its occupancy;</li>
<li>If is it not possible to improve the model any further, because the data are insufficient to learn additional parameters, and autocorrelation remains, then we can somehow “include it” in the model.</li>
</ul>
<p>The second option means that we will not “fix” the model, but let it aknowledge that it is missing something. Making reliable predictions will come at the cost of increased uncertainty.</p>
<div id="moving-average-models" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Moving average models<a class="anchor" aria-label="anchor" href="#moving-average-models"><i class="fas fa-link"></i></a>
</h2>
<p>So far, the models we have used in tutorial 1 and 2 looked like this:</p>
<p><span class="math display" id="eq:autocorr1">\[\begin{equation}
y_t = f(x_t) + \varepsilon_t \tag{5.1}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(y_t\)</span> are observed dependent data (energy use) and <span class="math inline">\(f\)</span> can be any function of some explanatory variables <span class="math inline">\(x_t\)</span> (outdoor temperature, occupancy, solar irradiance, etc.): linear, change-point, or other.</p>
<p>However, if we found after model fitting that <a href="optCchangepoint.html#tuto2residuals">residuals were correlated</a>, then Eq. <a href="optCautocorr.html#eq:autocorr1">(5.1)</a> no longer holds. Instead, the previous tutorial found a significant correlation between the consecutive errors <span class="math inline">\(y_t - f(x_t)\)</span> of the model:</p>
<p><span class="math display" id="eq:autocorr2">\[\begin{equation}
y_t - f(x_t) = \theta_1 \varepsilon_{t-1} + \mathrm{normal}(0,\sigma^2) \tag{5.2}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\theta_1\)</span> is the lag-1 autocorrelation on Fig. <a href="optCchangepoint.html#fig:tuto2corr1">4.5</a> and the slope of the trend on Fig. <a href="optCchangepoint.html#fig:tuto2corr2">4.6</a>.</p>
<p>The observational model is therefore:</p>
<p><span class="math display" id="eq:autocorr3">\[\begin{equation}
y_t = f(x_t) + \theta_1 \varepsilon_{t-1} + \varepsilon_t \tag{5.3}
\end{equation}\]</span></p>
<p>The last term of this equation are the errors of this new model, which we hope is are now independent no longer autocorrelated: <span class="math inline">\(\varepsilon_t\sim N(0,\sigma^2)\)</span>.</p>
<p>In a more general form of this equation, we can even assume that residuals are correlated with their own previous values up to a higher lag <span class="math inline">\(Q\)</span>:</p>
<p><span class="math display" id="eq:autocorr4">\[\begin{equation}
y_t = f(x_t) + \theta_1 \varepsilon_{t-1} + \dots + \theta_Q \varepsilon_{t-Q} + \varepsilon_t \tag{5.4}
\end{equation}\]</span></p>
<p>This is the formulation of a Moving Average (MA) model of order <span class="math inline">\(Q\)</span>, <span class="math inline">\(\mathrm{MA}(Q)\)</span>. It uses previous errors as predictors for future outcomes. Compared to the original model <span class="math inline">\(f(x_t)\)</span>, this model has additional parameters <span class="math inline">\(\left(\theta_1,...,\theta_Q\right)\)</span>. The Stan documentation has <a href="https://mc-stan.org/docs/stan-users-guide/moving-average-models.html">a page on MA models</a>, which we used as starting point for this tutorial.</p>
</div>
<div id="data-2" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Data<a class="anchor" aria-label="anchor" href="#data-2"><i class="fas fa-link"></i></a>
</h2>
<p>This first block is just the same code as the beginning of <a href="optCchangepoint">tutorial 2</a>, rewritten here as is.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/">rstan</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>

<span class="co"># Reading data and identifying the dates</span>
<span class="va">df.pre</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/building6pre.csv"</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">mdy_hm</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>
<span class="va">df.dur</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/building6during.csv"</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">mdy_hm</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>
<span class="va">df.post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/building6post.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">mdy_hm</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Quick preprocessing and daily averaging</span>
<span class="va">daily.average</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html">as_date</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>T <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">OAT</span><span class="op">)</span><span class="op">-</span><span class="fl">32</span><span class="op">)</span><span class="op">/</span><span class="fl">1.8</span>,
              E <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`Building 6 kW`</span><span class="op">)</span>,
              .groups <span class="op">=</span> <span class="st">'drop'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>wday <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">wday</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span>,
           week.end <span class="op">=</span> <span class="va">wday</span><span class="op">==</span><span class="fl">1</span> <span class="op">|</span> <span class="va">wday</span><span class="op">==</span><span class="fl">7</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Filtering out the week ends</span>
<span class="va">df.pre.day</span>  <span class="op">&lt;-</span> <span class="fu">daily.average</span><span class="op">(</span><span class="va">df.pre</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">week.end</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>period <span class="op">=</span> <span class="st">'pre'</span><span class="op">)</span>
<span class="va">df.dur.day</span>  <span class="op">&lt;-</span> <span class="fu">daily.average</span><span class="op">(</span><span class="va">df.dur</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">week.end</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>period <span class="op">=</span> <span class="st">'during'</span><span class="op">)</span>
<span class="va">df.post.day</span> <span class="op">&lt;-</span> <span class="fu">daily.average</span><span class="op">(</span><span class="va">df.post</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">week.end</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>period <span class="op">=</span> <span class="st">'post'</span><span class="op">)</span></code></pre></div>
</div>
<div id="modelling-and-training-1" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Modelling and training<a class="anchor" aria-label="anchor" href="#modelling-and-training-1"><i class="fas fa-link"></i></a>
</h2>
<div id="model-specification-1" class="section level3" number="5.3.1">
<h3>
<span class="header-section-number">5.3.1</span> Model specification<a class="anchor" aria-label="anchor" href="#model-specification-1"><i class="fas fa-link"></i></a>
</h3>
<p>We will use the same change-point model as in tutorial 2, only modified to include a regression term for the previous error <span class="math inline">\(\varepsilon_{n-1}\)</span>. This makes it a first order moving average model, <span class="math inline">\(\mathrm{MA}(1)\)</span>:</p>
<p><span class="math display" id="eq:autocorr6">\[\begin{align}
y_n &amp; = \alpha + \beta_{h}(\tau_{h}-x_n)^+ + \beta_{c}(x_n-\tau_{c})^+ + \theta_1 \varepsilon_{n-1} + \varepsilon_n \tag{5.5} \\
\varepsilon_n &amp; \sim \mathrm{normal}\left(0, \sigma\right) \tag{5.6}
\end{align}\]</span></p>
<p>The Stan code for this model is in a separate file <code>changepoint_ma1.stan</code>, and is more complicated than the original.</p>
<p>Firstly, there is a new block called <code>transformed parameters</code>, between <code>parameters</code> and <code>model</code>, which calculates the main terms of Eq. <a href="optCautocorr.html#eq:autocorr5">(5.5)</a> so that the model itself is written concisely.</p>
<ul>
<li>
<code>f_pre</code> and <code>f_post</code> are the values of the change-point function itself, respectively during the pre and post periods.</li>
<li>
<code>epsilon</code> are the residuals according to Eq. <a href="optCautocorr.html#eq:autocorr5">(5.5)</a>, calculated one after another.</li>
</ul>
<pre><code>transformed parameters {
  vector[N_pre] f_pre;
  vector[N_pre] epsilon;
  vector[N_post] f_post;
  for (n in 1:N_pre) {
    f_pre[n] = alpha + beta_h * fmax(tau_h-t_pre[n], 0) + beta_c * fmax(t_pre[n]-tau_c, 0);
  }
  epsilon[1] = y_pre[1] - f_pre[1];
  for (n in 2:N_pre) {
    epsilon[n] = y_pre[n] - f_pre[n] - theta*epsilon[n-1];
  }
  for (n in 1:N_post) {
    f_post[n] = alpha + beta_h * fmax(tau_h-t_post[n], 0) + beta_c * fmax(t_post[n]-tau_c, 0);
  }
}</code></pre>
<p>Then, the <code>model</code> reproduces Eq. <a href="optCautocorr.html#eq:autocorr5">(5.5)</a>. Its formulation is quite tidy, since we defined each term in the previous block.</p>
<pre><code>model {
  ...
  for (n in 2:N_pre) {
    y_pre[n] ~ normal(f_pre[n] + theta*epsilon[n-1], sigma);
  }
}</code></pre>
<p>The block starts with the definition of some priors, which me omitted here although they belong in the model. Priors are important in a Bayesian workflow, and they are often the first way to regularise a model if convergence is difficult.</p>
<p>Finally, the <code>generated quantities</code> block is used again to generate predictions of energy use and savings with each iteration.</p>
<pre><code>generated quantities {
  ...
  
  y_pre_pred[1] = normal_rng(f_pre[1], sigma);
  for (n in 2:N_pre) {
    y_pre_pred[n] = normal_rng(f_pre[n] + theta*epsilon[n-1], sigma);
  }
  
  // Forecasts with increased uncertainty due to the autocorrelation
  y_post_pred[1] = normal_rng(f_post[1], sigma);
  for (n in 2:N_post) {
    y_post_pred[n] = normal_rng(f_post[n], sigma * sqrt(1+theta^2));
    savings += y_post_pred[n] - y_post[n];
  }
}</code></pre>
<p>The predictions of energy use during the baseline (pre) period <span class="math inline">\(\tilde{y}_\mathit{pre}\)</span> account for previous residuals. However, a keen eye may have noticed a difference in the predictions of the post period <span class="math inline">\(\tilde{y}_\mathit{post}\)</span>. Indeed, we do not know the value of residuals <em>after</em> the fitting period, since they are the difference between model predictions and the consumption of a hypothetical building <em>if it were identical to the pre-ECM building but in the post-ECM conditions</em>.</p>
<p>Therefore, <a href="https://otexts.com/fpp2/arima-forecasting.html">the muti-step prediction intervals of ARIMA models</a> (which MA models are a subclass of) must account for an increased uncertainty <span class="math inline">\(\hat{\sigma}_h\)</span> formulated after the MA regression coefficients <span class="math inline">\(\theta_i\)</span>:</p>
<p><span class="math display" id="eq:autocorr8">\[\begin{align}
\tilde{y}_\mathit{post} &amp; \sim \mathrm{normal}\left(f(x_\mathit{post}), \sigma_h^2 \right) \tag{5.7} \\
\hat{\sigma}_h &amp; = \hat{\sigma}^2 \left[1+\sum_{i=1}^{h-1}\hat{\theta}_i^2\right] \tag{5.8}
\end{align}\]</span></p>
<p>We only have one <span class="math inline">\(\theta_1\)</span> coefficient in this <span class="math inline">\(\mathrm{MA}(1)\)</span> model, but Eq. <a href="optCautocorr.html#eq:autocorr8">(5.8)</a> applies to a <span class="math inline">\(\mathrm{MA}(Q)\)</span> model where we may want to include regression coefficients with several past errors.</p>
<p>If you are still following, congratulations! This concludes the theoretical part of these tutorials.</p>
</div>
<div id="model-fitting-1" class="section level3" number="5.3.2">
<h3>
<span class="header-section-number">5.3.2</span> Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting-1"><i class="fas fa-link"></i></a>
</h3>
<p>The next step is the same as in tutorial 2: defining a list which maps data to the Stan model, and calling the <code><a href="https://mc-stan.org/rstan/reference/stan.html">stan()</a></code> command to fit the model.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  N_pre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">)</span>,
  x_pre <span class="op">=</span> <span class="va">df.pre.day</span><span class="op">$</span><span class="cn">T</span>,
  y_pre <span class="op">=</span> <span class="va">df.pre.day</span><span class="op">$</span><span class="va">E</span>,
  N_post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.post.day</span><span class="op">)</span>,
  x_post <span class="op">=</span> <span class="va">df.post.day</span><span class="op">$</span><span class="cn">T</span>,
  y_post <span class="op">=</span> <span class="va">df.post.day</span><span class="op">$</span><span class="va">E</span>
<span class="op">)</span>

<span class="co"># Fitting the model</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan.html">stan</a></span><span class="op">(</span>
  file <span class="op">=</span> <span class="st">'models/changepoint_ma1.stan'</span>,  <span class="co"># Stan program</span>
  data <span class="op">=</span> <span class="va">model_data</span>,        <span class="co"># named list of data</span>
  chains <span class="op">=</span> <span class="fl">4</span>,               <span class="co"># number of Markov chains</span>
  warmup <span class="op">=</span> <span class="fl">3000</span>,            <span class="co"># number of warmup iterations per chain</span>
  iter <span class="op">=</span> <span class="fl">4000</span>,              <span class="co"># total number of iterations per chain</span>
  cores <span class="op">=</span> <span class="fl">2</span>,                <span class="co"># number of cores (could use one per chain)</span>
  refresh <span class="op">=</span> <span class="fl">0</span>,              <span class="co"># progress not shown</span>
<span class="op">)</span></code></pre></div>
<p>We notice that convergence may be more difficult due to the added <span class="math inline">\(\theta\)</span> parameter: the model knows that something “more uncertain” is happening and some local optima may disturb the traces. In order to help convergence, we had to narrow down the prior distributions, and to increase the warmup and iteration numbers copiously.</p>
</div>
</div>
<div id="results-2" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> Results<a class="anchor" aria-label="anchor" href="#results-2"><i class="fas fa-link"></i></a>
</h2>
<div id="first-look-at-results-1" class="section level3" number="5.4.1">
<h3>
<span class="header-section-number">5.4.1</span> First look at results<a class="anchor" aria-label="anchor" href="#first-look-at-results-1"><i class="fas fa-link"></i></a>
</h3>
<p>The first look we can have at our results comes from the <code>print</code>, <code>plot</code> and <code>pairs</code> methods associated with the <code>fit</code> object:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta_h"</span>, <span class="st">"tau_h"</span>, <span class="st">"beta_c"</span>, <span class="st">"tau_c"</span>, <span class="st">"sigma"</span>, <span class="st">"theta"</span>, <span class="st">"savings"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: changepoint_ma1.
## 4 chains, each with iter=4000; warmup=3000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##             mean se_mean      sd     2.5%      25%      50%      75%    97.5%
## alpha     834.49    0.25   13.51   807.75   825.59   834.49   843.64   860.49
## beta_h     32.91    0.05    2.66    27.81    31.02    32.85    34.74    38.13
## tau_h       6.33    0.02    0.78     5.04     5.74     6.25     6.90     7.94
## beta_c     27.75    0.06    2.89    22.48    25.68    27.58    29.66    33.83
## tau_c      15.62    0.02    1.04    13.74    14.84    15.59    16.42    17.50
## sigma      78.07    0.05    3.33    71.86    75.82    77.94    80.23    84.91
## theta       0.58    0.00    0.04     0.49     0.55     0.58     0.60     0.65
## savings 50201.41   37.68 2487.08 45317.23 48532.93 50185.63 51889.46 55017.87
##         n_eff Rhat
## alpha    2964    1
## beta_h   3360    1
## tau_h    2490    1
## beta_c   2695    1
## tau_c    2359    1
## sigma    4374    1
## theta    4456    1
## savings  4357    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Mar 30 15:26:00 2023.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta_h"</span>, <span class="st">"tau_h"</span>, <span class="st">"beta_c"</span>, <span class="st">"tau_c"</span>, <span class="st">"sigma"</span>, <span class="st">"lp__"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bayesmv_files/figure-html/acf03-1.png" width="672"></div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta_h"</span>, <span class="st">"tau_h"</span>, <span class="st">"beta_c"</span>, <span class="st">"tau_c"</span>, <span class="st">"sigma"</span>, <span class="st">"theta"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bayesmv_files/figure-html/acf03-2.png" width="672"></div>
<p>Remember that we need to validate our <a href="optClinreg.html#inferencediagnostics">inference diagnostics</a> criteria! All traces must match, <code>n_eff</code> should be in the thousands and <code>Rhat</code> exactly 1 for all parameters.</p>
</div>
<div id="model-checking-1" class="section level3" number="5.4.2">
<h3>
<span class="header-section-number">5.4.2</span> Model checking<a class="anchor" aria-label="anchor" href="#model-checking-1"><i class="fas fa-link"></i></a>
</h3>
<p>The model checking metrics are the same as usual: coefficient of determination <span class="math inline">\(R^2\)</span>, CV(RMSE), F-statistic… Here we calculate them only from the mean prediction rather than the full posterior distribution.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">la</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html">extract</a></span><span class="op">(</span><span class="va">fit</span>, permuted <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">predict.mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">la</span><span class="op">$</span><span class="va">y_pre_pred</span><span class="op">)</span>

<span class="va">residuals</span> <span class="op">&lt;-</span> <span class="va">predict.mean</span> <span class="op">-</span> <span class="va">df.pre.day</span><span class="op">$</span><span class="va">E</span>      <span class="co"># residuals</span>
<span class="va">ssres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>                     <span class="co"># sum of squared residuals</span>
<span class="va">sstot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">$</span><span class="va">E</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">$</span><span class="va">E</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="co"># total sum of squares</span>

<span class="va">R2</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">ssres</span> <span class="op">/</span> <span class="va">sstot</span>   <span class="co"># coefficient of determination</span>
<span class="va">CVRMSE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">ssres</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">$</span><span class="va">E</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"R2 ="</span>, <span class="va">R2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"CV(RMSE) ="</span>, <span class="va">CVRMSE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "R2 = 0.777573944547254"
## [1] "CV(RMSE) = 0.0794597067720026"</code></pre>
<p>The <span class="math inline">\(R^2\)</span> has increased from 0.66 to 0.77 since we added the <span class="math inline">\(\mathrm{MA}(1)\)</span> regression coefficient, and the CV(RMSE) has decreased. This suggests that the model better explains the data’s variance.</p>
</div>
<div id="savings" class="section level3" number="5.4.3">
<h3>
<span class="header-section-number">5.4.3</span> Savings<a class="anchor" aria-label="anchor" href="#savings"><i class="fas fa-link"></i></a>
</h3>
<p>We choose to skip the prediction plot and go straight to the savings estimate and its confidence bounds:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">la</span><span class="op">$</span><span class="va">savings</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##     2.5%      10%      50%      90%    97.5% 
## 45317.23 47030.45 50185.63 53398.07 55017.87</code></pre>
<p>Compared to the results of <a href="optCchangepoint.html#tuto2predictions">tutorial 2</a>, the mean estimated savings are similar, but the uncertainty is about 10% larger.</p>
</div>
<div id="residuals" class="section level3" number="5.4.4">
<h3>
<span class="header-section-number">5.4.4</span> Residuals<a class="anchor" aria-label="anchor" href="#residuals"><i class="fas fa-link"></i></a>
</h3>
<p>The whole point of this tutorial, compared to the previous one, is to reduce the autocorrelation of the prediction residuals, which would be a sign of a biased models and unreliable inferences. Have we succeded?</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/acf.html">acf</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:tuto3corr1"></span>
<img src="bayesmv_files/figure-html/tuto3corr1-1.png" alt="Autocorrelation function of prediction residuals" width="672"><p class="caption">
Figure 5.1: Autocorrelation function of prediction residuals
</p>
</div>
<p>Every vertical line of this graph shows the correlation coefficient between the values of a series (here <code>residuals</code>) and its own values with a certain lag.</p>
<p>The lag-1 ACF has been significantly reduced. The cause for the correlation between consecutive residuals has not been solved, but the model now “knows” that something unexplained is causing it: predictions were made more uncertain as a way to aknowledge it.</p>
<p>We can zoom in on the lag-1 autocorrelation by plotting residuals versus their own previous value:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">residuals</span>, y<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">residuals</span>, n<span class="op">=</span><span class="fl">1</span>, default<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:tuto3corr2"></span>
<img src="bayesmv_files/figure-html/tuto3corr2-1.png" alt="Correlation of consecutive residuals" width="672"><p class="caption">
Figure 5.2: Correlation of consecutive residuals
</p>
</div>
<p>There is no longer a visible trend on this scatter plot.</p>
<p>However, we can notice on Fig. @(fig:tuto3corr1) that some autocorrelation remains every 5 lags. Remember that since we filtered out week ends, each week of data comprises 5 measurements. Therefore, it looks like some weekly pattern has still not been properly captured.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">residuals</span>, y<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">residuals</span>, n<span class="op">=</span><span class="fl">5</span>, default<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:tuto3corr3"></span>
<img src="bayesmv_files/figure-html/tuto3corr3-1.png" alt="Correlation of residuals with lag-5" width="672"><p class="caption">
Figure 5.3: Correlation of residuals with lag-5
</p>
</div>
<p>There is a trend here. We need to define a new model which includes regression terms for the lag-1 and lag-5 errors:</p>
<p><span class="math display" id="eq:autocorr10">\[\begin{align}
y_n &amp; = \alpha + \beta_{h}(\tau_{h}-x_n)^+ + \beta_{c}(x_n-\tau_{c})^+ + \theta_1 \varepsilon_{n-1} + \theta_5 \varepsilon_{n-5} + \varepsilon_n \tag{5.9} \\
\varepsilon_n &amp; \sim \mathrm{normal}\left(0, \sigma\right) \tag{5.10}
\end{align}\]</span></p>
<p>We leave this as an exercise for the reader!</p>

</div>
</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="optCchangepoint.html"><span class="header-section-number">4</span> Tutorial 2: increasing model complexity</a></div>
<div class="next"><a href="optDbasics.html"><span class="header-section-number">6</span> Option D basics</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#optCautocorr"><span class="header-section-number">5</span> Tutorial 3: correlated residuals</a></li>
<li><a class="nav-link" href="#moving-average-models"><span class="header-section-number">5.1</span> Moving average models</a></li>
<li><a class="nav-link" href="#data-2"><span class="header-section-number">5.2</span> Data</a></li>
<li>
<a class="nav-link" href="#modelling-and-training-1"><span class="header-section-number">5.3</span> Modelling and training</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#model-specification-1"><span class="header-section-number">5.3.1</span> Model specification</a></li>
<li><a class="nav-link" href="#model-fitting-1"><span class="header-section-number">5.3.2</span> Model fitting</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#results-2"><span class="header-section-number">5.4</span> Results</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#first-look-at-results-1"><span class="header-section-number">5.4.1</span> First look at results</a></li>
<li><a class="nav-link" href="#model-checking-1"><span class="header-section-number">5.4.2</span> Model checking</a></li>
<li><a class="nav-link" href="#savings"><span class="header-section-number">5.4.3</span> Savings</a></li>
<li><a class="nav-link" href="#residuals"><span class="header-section-number">5.4.4</span> Residuals</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/srouchier/bayesmv/blob/master/14-optCautocorr.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/srouchier/bayesmv/edit/master/14-optCautocorr.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bayesian Measurement and Verification</strong>" was written by Simon Rouchier. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
