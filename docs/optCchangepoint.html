<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 4 Tutorial 2: increasing model complexity | Bayesian Measurement and Verification</title>
<meta name="author" content="Simon Rouchier">
<meta name="description" content="The first tutorial has reassured us on the ability of the Bayesian method to obtain the same results (energy use predictions, savings uncertainty, model checking and validation metrics) as we...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="Chapter 4 Tutorial 2: increasing model complexity | Bayesian Measurement and Verification">
<meta property="og:type" content="book">
<meta property="og:description" content="The first tutorial has reassured us on the ability of the Bayesian method to obtain the same results (energy use predictions, savings uncertainty, model checking and validation metrics) as we...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 4 Tutorial 2: increasing model complexity | Bayesian Measurement and Verification">
<meta name="twitter:description" content="The first tutorial has reassured us on the ability of the Bayesian method to obtain the same results (energy use predictions, savings uncertainty, model checking and validation metrics) as we...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Bayesian Measurement and Verification</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li class="book-part">Background</li>
<li><a class="" href="back-mv.html"><span class="header-section-number">1</span> Measurement and verification</a></li>
<li><a class="" href="back-bayes.html"><span class="header-section-number">2</span> Bayesian data analysis</a></li>
<li class="book-part">Whole building M&amp;V: option C</li>
<li><a class="" href="optClinreg.html"><span class="header-section-number">3</span> Tutorial 1: linear regression and introduction to Stan</a></li>
<li><a class="active" href="optCchangepoint.html"><span class="header-section-number">4</span> Tutorial 2: increasing model complexity</a></li>
<li><a class="" href="optCautocorr.html"><span class="header-section-number">5</span> Tutorial 3: correlated residuals</a></li>
<li class="book-part">Option D</li>
<li><a class="" href="optDbasics.html"><span class="header-section-number">6</span> Option D basics</a></li>
<li><a class="" href="bayesian-calibration.html"><span class="header-section-number">7</span> Bayesian calibration</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/srouchier/bayesmv">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="optCchangepoint" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> Tutorial 2: increasing model complexity<a class="anchor" aria-label="anchor" href="#optCchangepoint"><i class="fas fa-link"></i></a>
</h1>
<p>The <a href="optClinreg.html#optClinreg">first tutorial</a> has reassured us on the ability of the Bayesian method to obtain the same results (energy use predictions, savings uncertainty, model checking and validation metrics) as we would have analytically.</p>
<p>This second tutorial now illustrates two of <a href="back-bayes.html#motivation">its advantages</a>:</p>
<ul>
<li>The ability to automatically estimate uncertainty regardless of model structure;</li>
<li>The ability to include prior knowledge on model parameters.</li>
</ul>
<div id="data-1" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> Data<a class="anchor" aria-label="anchor" href="#data-1"><i class="fas fa-link"></i></a>
</h2>
<div id="data-overview" class="section level3" number="4.1.1">
<h3>
<span class="header-section-number">4.1.1</span> Data overview<a class="anchor" aria-label="anchor" href="#data-overview"><i class="fas fa-link"></i></a>
</h3>
<p>The data used in this example is the hourly electricity consumption and outdoor air temperature data for a commercial building in Richmond, USA. Three file are available: <code>building6pre.csv</code>, <code>building6during.csv</code> and <code>building6post.csv</code>, respectively before and after some energy conservation measure has been applied.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/">rstan</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>

<span class="va">df.pre</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/building6pre.csv"</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">mdy_hm</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>
<span class="va">df.dur</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/building6during.csv"</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">mdy_hm</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>
<span class="va">df.post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/building6post.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">mdy_hm</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df.pre</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">&lt;</span><span class="fl">7</span><span class="op">)</span>,
            mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Date</span>, y<span class="op">=</span><span class="va">`Building 6 kW`</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:cp01"></span>
<img src="bayesmv_files/figure-html/cp01-1.png" alt="Pre-ECM data (first 6 months)" width="672"><p class="caption">
Figure 4.1: Pre-ECM data (first 6 months)
</p>
</div>
<ul>
<li>The data has a hourly time step size. Every hour, the outdoor air temperature and energy use are available.</li>
<li>The electricity use is higher in summer and in winter than in mid-season. This suggests that this consumption data includes both heating and cooling appliances.</li>
<li>Week-ends are clearly visible with a lower consumption than in the working days of the week.</li>
</ul>
</div>
<div id="subset-selection" class="section level3" number="4.1.2">
<h3>
<span class="header-section-number">4.1.2</span> Subset selection<a class="anchor" aria-label="anchor" href="#subset-selection"><i class="fas fa-link"></i></a>
</h3>
<p>Averaging the data over daily time steps should allow to overlook the dependence between consecutive measurements. In turn, this allows using a model which will be much simpler than time series models, but will only be capable of low frequency predictions.</p>
<p>The following block creates new datasets from the original ones:</p>
<ul>
<li>Measurements are daily averaged</li>
<li>A categorical variable is added to indicate week ends.</li>
</ul>
<p>Then, we plot the daily energy use <span class="math inline">\(E\)</span> (kWh) versus the outdoor temperature <span class="math inline">\(T\)</span> (°C) for both values of the <code>week.end</code> categorical variable in the “pre” dataset.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">daily.average</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html">as_date</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>T <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">OAT</span><span class="op">)</span><span class="op">-</span><span class="fl">32</span><span class="op">)</span><span class="op">/</span><span class="fl">1.8</span>,
              E <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`Building 6 kW`</span><span class="op">)</span>,
              .groups <span class="op">=</span> <span class="st">'drop'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>wday <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">wday</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span>,
           week.end <span class="op">=</span> <span class="va">wday</span><span class="op">==</span><span class="fl">1</span> <span class="op">|</span> <span class="va">wday</span><span class="op">==</span><span class="fl">7</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">df.pre.day</span>  <span class="op">&lt;-</span> <span class="fu">daily.average</span><span class="op">(</span><span class="va">df.pre</span><span class="op">)</span>
<span class="va">df.dur.day</span>  <span class="op">&lt;-</span> <span class="fu">daily.average</span><span class="op">(</span><span class="va">df.dur</span><span class="op">)</span>
<span class="va">df.post.day</span> <span class="op">&lt;-</span> <span class="fu">daily.average</span><span class="op">(</span><span class="va">df.post</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df.pre.day</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="cn">T</span>, y<span class="op">=</span><span class="va">E</span>, color<span class="op">=</span><span class="va">week.end</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:cp02"></span>
<img src="bayesmv_files/figure-html/cp02-1.png" alt="Daily electricity use vs outdoor temperature" width="672"><p class="caption">
Figure 4.2: Daily electricity use vs outdoor temperature
</p>
</div>
<p>It seems fitting to train separate models for the working days and the week ends, because the energy use is clearly different between the two sets. In this tutorial, we will only consider working days, as there aren’t many available data points for the week ends, but it is possible to do both.</p>
<p>Finally we filter out weekends and compare all three datasets in terms of energy use versus outdoor temperature:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df.pre.day</span>  <span class="op">&lt;-</span> <span class="va">df.pre.day</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">week.end</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>period <span class="op">=</span> <span class="st">'pre'</span><span class="op">)</span>
<span class="va">df.dur.day</span>  <span class="op">&lt;-</span> <span class="va">df.dur.day</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">week.end</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>period <span class="op">=</span> <span class="st">'during'</span><span class="op">)</span>
<span class="va">df.post.day</span> <span class="op">&lt;-</span> <span class="va">df.post.day</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">week.end</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>period <span class="op">=</span> <span class="st">'post'</span><span class="op">)</span>

<span class="va">df.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">df.pre.day</span>, <span class="va">df.dur.day</span>, <span class="va">df.post.day</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df.all</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="cn">T</span>, y<span class="op">=</span><span class="va">E</span>, color<span class="op">=</span><span class="va">period</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:cp03"></span>
<img src="bayesmv_files/figure-html/cp03-1.png" alt="Daily electricity use vs outdoor temperature, selected data in three periods" width="672"><p class="caption">
Figure 4.3: Daily electricity use vs outdoor temperature, selected data in three periods
</p>
</div>
</div>
</div>
<div id="modelling-and-training" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Modelling and training<a class="anchor" aria-label="anchor" href="#modelling-and-training"><i class="fas fa-link"></i></a>
</h2>
<div id="model-specification" class="section level3" number="4.2.1">
<h3>
<span class="header-section-number">4.2.1</span> Model specification<a class="anchor" aria-label="anchor" href="#model-specification"><i class="fas fa-link"></i></a>
</h3>
<p>After looking at the data, we can suggest using a change-point model which will include the effects of heating and cooling separately. The expected daily energy use <span class="math inline">\(y\)</span> (in kWh per day) is a function of the outdoor temperature <span class="math inline">\(x\)</span> and of a number of parameters:</p>
<p><span class="math display" id="eq:cp2">\[\begin{align}
y_n &amp; = \alpha + \beta_{h}(\tau_{h}-x_n)^+ + \beta_{c}(x_n-\tau_{c})^+ + \varepsilon_n \tag{4.1} \\
\varepsilon_n &amp; \sim \mathrm{normal}\left(0, \sigma\right) \tag{4.2}
\end{align}\]</span></p>
<p>Where the <span class="math inline">\(h\)</span> and <span class="math inline">\(c\)</span> subscripts indicate heating and cooling modes. The <span class="math inline">\(+\)</span> superscript indicates that a term is only applied if above zero. This equation means that we expect the energy use <span class="math inline">\(y\)</span> to be a normal distribution centered around a change-point model, with a constant standard deviation <span class="math inline">\(\sigma\)</span>.</p>
<p>This model has 6 possible parameters: a constant term <span class="math inline">\(\alpha\)</span>, two slopes <span class="math inline">\(\beta\)</span>, two change points <span class="math inline">\(\tau\)</span> and the error scale <span class="math inline">\(\sigma\)</span>. It is not an ordinary linear regression models: there is no analytical way to formulate the prediction uncertainty while accounting for the uncertainty of the change point estimates.</p>
</div>
<div id="model-specification-with-stan" class="section level3" number="4.2.2">
<h3>
<span class="header-section-number">4.2.2</span> Model specification with Stan<a class="anchor" aria-label="anchor" href="#model-specification-with-stan"><i class="fas fa-link"></i></a>
</h3>
<p>The Stan code for the full model is written <a href="https://github.com/srouchier/bayesmv/blob/main/models/changepoint.stan">in a separate file <code>changepoint.stan</code></a>. We only show some parts of it here. See <a href="optClinreg.html#optClinreg">Tutorial 1</a> for a quick introduction on the components of a Stan model.</p>
<p>The names of data variables and parameters are declared in the <code>data</code> and <code>parameter</code> blocks which we don’t show here. These names should be clear from the above specification of the model. Here is the <code>model</code> block:</p>
<pre><code>model {
  // Assigning prior distributions on some parameters
  alpha ~ normal(800, 100);
  tau_h ~ normal(8, 5);
  tau_c ~ normal(18, 5);
  beta_h ~ normal(40, 15);
  beta_c ~ normal(40, 15);
  // Observational model
  for (n in 1:N_pre) {
    y_pre[n] ~ normal(alpha + beta_h * fmax(tau_h-x_pre[n], 0)
                            + beta_c * fmax(x_pre[n]-tau_c, 0), sigma);
  }
}</code></pre>
<p>The main difference with our first tutorial is that we added prior distributions on the parameters. They help regularizing the inverse problem because it may have a non-unique set of solutions. By adding the priors, we “help” traces converge towards physically consistent values that we chose after looking at the data.</p>
<p>There is also a <code>generated quantities</code> block:</p>
<pre><code>generated quantities {
  // This block is for posterior predictions. It is not part of model training
  vector[N_pre] y_pre_pred;
  vector[N_post] y_post_pred;
  real savings = 0;
  
  for (n in 1:N_pre) {
    y_pre_pred[n] = normal_rng(alpha + beta_h * fmax(tau_h-x_pre[n], 0)
                                     + beta_c * fmax(x_pre[n]-tau_c, 0), sigma);
  }
  
  for (n in 1:N_post) {
    y_post_pred[n] = normal_rng(alpha + beta_h * fmax(tau_h-x_post[n], 0)
                                      + beta_c * fmax(x_post[n]-tau_c, 0), sigma);
    savings += y_post_pred[n] - y_post[n];
  }
}</code></pre>
<p>This block handles the calculation of some posterior variables we want to watch: energy use predictions by the model during the “pre” and “post” periods, and energy savings.</p>
<p>Note that predictions are calculated by drawing from a Normal distribution with the <span class="math inline">\(\sigma\)</span> error of each sample. Therefore, we will obtain a full description of the prediction intervals.</p>
</div>
<div id="model-fitting" class="section level3" number="4.2.3">
<h3>
<span class="header-section-number">4.2.3</span> Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"><i class="fas fa-link"></i></a>
</h3>
<p>The next step is to create a list called <code>model_data</code>, which maps our data to each appropriate variable into the Stan model.</p>
<p>Then the <code><a href="https://mc-stan.org/rstan/reference/stan.html">stan()</a></code> command fits the model, given in the <code>changepoint.stan</code> file, using this data.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  N_pre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">)</span>,
  x_pre <span class="op">=</span> <span class="va">df.pre.day</span><span class="op">$</span><span class="cn">T</span>,
  y_pre <span class="op">=</span> <span class="va">df.pre.day</span><span class="op">$</span><span class="va">E</span>,
  N_post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.post.day</span><span class="op">)</span>,
  x_post <span class="op">=</span> <span class="va">df.post.day</span><span class="op">$</span><span class="cn">T</span>,
  y_post <span class="op">=</span> <span class="va">df.post.day</span><span class="op">$</span><span class="va">E</span>
<span class="op">)</span>

<span class="co"># Fitting the model</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan.html">stan</a></span><span class="op">(</span>
  file <span class="op">=</span> <span class="st">'models/changepoint.stan'</span>,  <span class="co"># Stan program</span>
  data <span class="op">=</span> <span class="va">model_data</span>,        <span class="co"># named list of data</span>
  chains <span class="op">=</span> <span class="fl">4</span>,               <span class="co"># number of Markov chains</span>
  warmup <span class="op">=</span> <span class="fl">1000</span>,            <span class="co"># number of warmup iterations per chain</span>
  iter <span class="op">=</span> <span class="fl">2000</span>,              <span class="co"># total number of iterations per chain</span>
  cores <span class="op">=</span> <span class="fl">2</span>,                <span class="co"># number of cores (could use one per chain)</span>
  refresh <span class="op">=</span> <span class="fl">0</span>,              <span class="co"># progress not shown</span>
<span class="op">)</span></code></pre></div>
<p>As in the first tutorial, fitting may result in a number of warnings, telling us that some problems may have occurred: divergent transitions, large R-hat values, low Effective Sample Size… Obtaining a fit without these warnings takes some practice but is essential for an unbiased interpretation of the inferred variables and predictions.</p>
<p>A lot of problems can be solved with an appropriate choice of priors.</p>
</div>
</div>
<div id="results-1" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Results<a class="anchor" aria-label="anchor" href="#results-1"><i class="fas fa-link"></i></a>
</h2>
<div id="first-look-at-results" class="section level3" number="4.3.1">
<h3>
<span class="header-section-number">4.3.1</span> First look at results<a class="anchor" aria-label="anchor" href="#first-look-at-results"><i class="fas fa-link"></i></a>
</h3>
<p>The first look we can have at our results comes from the <code>print</code>, <code>plot</code> and <code>pairs</code> methods associated with the <code>fit</code> object:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta_h"</span>, <span class="st">"tau_h"</span>, <span class="st">"beta_c"</span>, <span class="st">"tau_c"</span>, <span class="st">"sigma"</span>, <span class="st">"savings"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: changepoint.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##             mean se_mean      sd     2.5%      25%      50%      75%    97.5%
## alpha     829.64    0.24   11.88   804.68   822.03   829.99   837.98   851.42
## beta_h     33.37    0.06    2.68    28.19    31.55    33.38    35.15    38.67
## tau_h       6.51    0.02    0.75     5.23     5.98     6.45     6.97     8.15
## beta_c     29.26    0.07    3.24    23.16    27.02    29.11    31.42    35.84
## tau_c      15.78    0.02    0.98    13.70    15.16    15.84    16.47    17.50
## sigma      96.70    0.08    4.34    88.56    93.79    96.55    99.58   105.64
## savings 49922.98   35.51 2253.21 45425.69 48464.88 49899.17 51406.99 54365.56
##         n_eff Rhat
## alpha    2377    1
## beta_h   2256    1
## tau_h    1790    1
## beta_c   2451    1
## tau_c    2068    1
## sigma    3256    1
## savings  4027    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Mar 30 15:15:55 2023.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta_h"</span>, <span class="st">"tau_h"</span>, <span class="st">"beta_c"</span>, <span class="st">"tau_c"</span>, <span class="st">"sigma"</span>, <span class="st">"lp__"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bayesmv_files/figure-html/cp05-1.png" width="672"></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta_h"</span>, <span class="st">"tau_h"</span>, <span class="st">"beta_c"</span>, <span class="st">"tau_c"</span>, <span class="st">"sigma"</span>, <span class="st">"savings"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bayesmv_files/figure-html/cp05-2.png" width="672"></div>
<ul>
<li>Inference diagnostics are fine: for all parameters, <code>n_eff</code> is in the thousands and <code>Rhat</code> is 1.</li>
<li>All model parameters are statistically significant: as their 95% confidence interval doesn’t include zero.</li>
<li>All traces have converged to the same range.</li>
<li>The pairplot suggests a strong correlation between some parameters, but nothing alarming.</li>
</ul>
</div>
<div id="model-checking" class="section level3" number="4.3.2">
<h3>
<span class="header-section-number">4.3.2</span> Model checking<a class="anchor" aria-label="anchor" href="#model-checking"><i class="fas fa-link"></i></a>
</h3>
<p>The model checking metrics are the same as usual: coefficient of determination <span class="math inline">\(R^2\)</span>, CV(RMSE), F-statistic… Here we calculate them only from the mean prediction rather than the full posterior distribution.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">la</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html">extract</a></span><span class="op">(</span><span class="va">fit</span>, permuted <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">predict.mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">la</span><span class="op">$</span><span class="va">y_pre_pred</span><span class="op">)</span>

<span class="va">residuals</span> <span class="op">&lt;-</span> <span class="va">predict.mean</span> <span class="op">-</span> <span class="va">df.pre.day</span><span class="op">$</span><span class="va">E</span>      <span class="co"># residuals</span>
<span class="va">ssres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>                     <span class="co"># sum of squared residuals</span>
<span class="va">sstot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">$</span><span class="va">E</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">$</span><span class="va">E</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="co"># total sum of squares</span>

<span class="va">R2</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">ssres</span> <span class="op">/</span> <span class="va">sstot</span>   <span class="co"># coefficient of determination</span>
<span class="va">CVRMSE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">ssres</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">$</span><span class="va">E</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"R2 ="</span>, <span class="va">R2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"CV(RMSE) ="</span>, <span class="va">CVRMSE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "R2 = 0.658934362997056"
## [1] "CV(RMSE) = 0.0983950183032571"</code></pre>
<p>Then we check for parameter adequacy with a <span class="math inline">\(p\)</span>-test:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Trace of all parameters and generated quantities</span>
<span class="va">traces</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="co"># Only the parameters</span>
<span class="va">traces.p</span> <span class="op">&lt;-</span> <span class="va">traces</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">'alpha'</span>, <span class="st">'beta_h'</span>, <span class="st">'beta_c'</span>, <span class="st">'tau_h'</span>, <span class="st">'tau_c'</span>, <span class="st">'sigma'</span><span class="op">)</span>

<span class="co"># The t-statistic is the ratio of mean to standard deviation of parameters</span>
<span class="va">t_stat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">traces.p</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">traces.p</span>, <span class="va">sd</span><span class="op">)</span>
<span class="co"># The p-value is easy to calculate from the t statistics</span>
<span class="va">ptest</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">pt</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">t_stat</span><span class="op">)</span>, df<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df.pre.day</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ptest</span><span class="op">)</span></code></pre></div>
<pre><code>##         alpha        beta_h        beta_c         tau_h         tau_c 
## 1.659427e-170  2.739440e-28  4.183726e-17  5.011267e-16  3.331417e-41 
##         sigma 
##  3.747296e-62</code></pre>
</div>
<div id="tuto2predictions" class="section level3" number="4.3.3">
<h3>
<span class="header-section-number">4.3.3</span> Predictions and savings<a class="anchor" aria-label="anchor" href="#tuto2predictions"><i class="fas fa-link"></i></a>
</h3>
<p>Our Stan model already calculates the expected output <span class="math inline">\(y\)</span> of the reporting period, for each sample <span class="math inline">\(\theta_i\)</span> of the posterior distribution. We can therefore display a probability distribution for each of the data points of the reporting period, and compare it with the measured data in the same period.</p>
<p>The following graph compares the energy use measured during the reporting period (points) with the probability distributions of energy use predicted by the model during the same period.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This method is more convenient to extract prediction quantiles and mean</span>
<span class="va">predict.quan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">la</span><span class="op">$</span><span class="va">y_post_pred</span>, <span class="fl">2</span>, <span class="va">quantile</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Adding prediction quantiles to the baseline dataframe</span>
<span class="va">df.post.day</span> <span class="op">&lt;-</span> <span class="va">df.post.day</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pred_low <span class="op">=</span> <span class="va">predict.quan</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>,
                                    pred_med <span class="op">=</span> <span class="va">predict.quan</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span>,
                                    pred_up <span class="op">=</span> <span class="va">predict.quan</span><span class="op">[</span><span class="fl">3</span>, <span class="op">]</span><span class="op">)</span>

<span class="co"># Plot</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df.post.day</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="cn">T</span>, y<span class="op">=</span><span class="va">E</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="cn">T</span>, y<span class="op">=</span><span class="va">pred_med</span><span class="op">)</span>, color<span class="op">=</span><span class="st">'red'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="cn">T</span>, ymin<span class="op">=</span><span class="va">pred_low</span>, ymax<span class="op">=</span><span class="va">pred_up</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">'red'</span>, alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:cp08"></span>
<img src="bayesmv_files/figure-html/cp08-1.png" alt="Model predictions and measurements in the post period" width="672"><p class="caption">
Figure 4.4: Model predictions and measurements in the post period
</p>
</div>
<p>The colored bands show a 95% prediction interval. The points are the measurements of the “post” period.</p>
<p>The savings, i.e. the difference between the measured energy use during the reporting period and their prediction by the model, have been included in the Stan model as well. Similarly to the prediction, the savings are therefore available as a probability distribution: we have a full description of any confidence interval we may wish for.</p>
<p>We can also choose to display any quantile of the posterior distribution of savings. This line displays the mean expected savings and the bounds of their 80% and 95% intervals:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">la</span><span class="op">$</span><span class="va">savings</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span>
<span class="co"># plot(fit, pars = c("savings") )</span></code></pre></div>
<pre><code>##     2.5%      10%      50%      90%    97.5% 
## 45425.69 47046.76 49899.17 52841.86 54365.56</code></pre>
</div>
</div>
<div id="tuto2residuals" class="section level2" number="4.4">
<h2>
<span class="header-section-number">4.4</span> Residuals<a class="anchor" aria-label="anchor" href="#tuto2residuals"><i class="fas fa-link"></i></a>
</h2>
<p>There is one thing we didn’t check.</p>
<p>An important validation step is to check for autocorrelation in the residuals of the fitted model, on the baseline data that was used for fitting. Autocorrelation is often a sign of insufficient model complexity, or that the form of the model error term has not been appropriately chosen. In case of strong remaining autocorrelation, inferences should be drawn with caution.</p>
<p>The autocorrelation function (ACF) is the easiest way to display autocorrelation of the variable <code>residuals</code>:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/acf.html">acf</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:tuto2corr1"></span>
<img src="bayesmv_files/figure-html/tuto2corr1-1.png" alt="Autocorrelation function of prediction residuals" width="672"><p class="caption">
Figure 4.5: Autocorrelation function of prediction residuals
</p>
</div>
<p>Every vertical line of this graph shows the correlation coefficient between the values of a series (here <code>residuals</code>) and its own values with a certain lag.</p>
<ul>
<li>For <code>Lag=0</code>, the ACF is 1. This is normal: a series is fully correlated with itself.</li>
<li>As much as possible, we want all other ACF values below the dotted line, a threshold value which depends on the length of data.</li>
<li>For <code>Lag=1</code>, the ACF is close to 0.7. This is the average correlation coefficient between residuals and their own previous value. As a consequence, the next lags have high ACF values as well.</li>
<li>There is an increased ACF every 5 lags. Reminder: we removed weekends, therefore our dataset has 5 rows per week. The data has a weekly pattern that our model doesn’t capture.</li>
</ul>
<p>We can zoom in on the lag-1 autocorrelation by plotting residuals versus their own previous value:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">residuals</span>, y<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">residuals</span>, n<span class="op">=</span><span class="fl">1</span>, default<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:tuto2corr2"></span>
<img src="bayesmv_files/figure-html/tuto2corr2-1.png" alt="Correlation of consecutive residuals" width="672"><p class="caption">
Figure 4.6: Correlation of consecutive residuals
</p>
</div>
<p>The autocorrelation graph suggests that our model doesn’t predict the variability of the data properly. We should therefore be very cautious when interpreting its inferences. This includes the uncertainty of the savings estimates.</p>
<p>In order to trust our inferences, we have two options:</p>
<ul>
<li>Improve the model so that it better describes the building’s electricity use and its dependency on weather and occupancy. This means more model parameters, but the dataset may no longer bring enough information to identify them.</li>
<li>Modify the model to account for an additional uncertainty due to the autocorrelation. This means we will not “fix” the model, but let it aknowledge that it is missing something: inferences will be more “cautious” (more uncertain but more reliable).</li>
</ul>
<p>In <a href="optCautocorr.html#optCautocorr">the next tutorial</a>, we show how to do the second option.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="optClinreg.html"><span class="header-section-number">3</span> Tutorial 1: linear regression and introduction to Stan</a></div>
<div class="next"><a href="optCautocorr.html"><span class="header-section-number">5</span> Tutorial 3: correlated residuals</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#optCchangepoint"><span class="header-section-number">4</span> Tutorial 2: increasing model complexity</a></li>
<li>
<a class="nav-link" href="#data-1"><span class="header-section-number">4.1</span> Data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#data-overview"><span class="header-section-number">4.1.1</span> Data overview</a></li>
<li><a class="nav-link" href="#subset-selection"><span class="header-section-number">4.1.2</span> Subset selection</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#modelling-and-training"><span class="header-section-number">4.2</span> Modelling and training</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#model-specification"><span class="header-section-number">4.2.1</span> Model specification</a></li>
<li><a class="nav-link" href="#model-specification-with-stan"><span class="header-section-number">4.2.2</span> Model specification with Stan</a></li>
<li><a class="nav-link" href="#model-fitting"><span class="header-section-number">4.2.3</span> Model fitting</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#results-1"><span class="header-section-number">4.3</span> Results</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#first-look-at-results"><span class="header-section-number">4.3.1</span> First look at results</a></li>
<li><a class="nav-link" href="#model-checking"><span class="header-section-number">4.3.2</span> Model checking</a></li>
<li><a class="nav-link" href="#tuto2predictions"><span class="header-section-number">4.3.3</span> Predictions and savings</a></li>
</ul>
</li>
<li><a class="nav-link" href="#tuto2residuals"><span class="header-section-number">4.4</span> Residuals</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/srouchier/bayesmv/blob/master/13-optCchangepoint.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/srouchier/bayesmv/edit/master/13-optCchangepoint.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bayesian Measurement and Verification</strong>" was written by Simon Rouchier. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
